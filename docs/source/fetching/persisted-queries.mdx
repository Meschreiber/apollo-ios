---
title: Persisted Queries
minVersion: 1.3.1
---

Apollo supports two separate but related features called **persisted queries** and **automated persisted queries** (APQs).
With both features, clients can execute a GraphQL operation by sending an operation's ID instead of the entire string. An operation's ID is the SHA256 hash of the full operation string. Querying by ID can significantly reduce latency and bandwidth usage for very large operation strings.

## Differences between persisted queries and APQ

The persisted queries feature requires operations to be preregistered in a **persisted query list** (**PQL**). 
The allows the PQL to act as a safelist of trusted operations made by your first-party apps. As such, persisted queries is a security feature as much as a performance one.

With APQs, if the server can't find the operation ID the client provides, the server returns an error indicating that it needs the full operation string. If the Apollo iOS client receives this error, it automatically retries the operation with the full operation string.

If you _only_ want to improve request latency and bandwidth usage, APQ addresses your use case. If you _also_ want to secure your supergraph with operation safelisting, you should preregister trusted operations in a PQL.

For more details on differences between persisted queries and APQ, see the [GraphOS persisted queries documentation](/graphos/operations/persisted-queries#differences-from-automatic-persisted).


### Requirements

Both persisted queries and APQ require Apollo iOS `1.3.1` or later.

Persisted queries is currently in [preview](/resources/product-launch-stages#preview) and has the following additional requirements:
- [GraphOS Enterprise plan](/graphos/enterprise/)
- [Apollo Router](/router) (v1.25.0+)

APQ has the following requirements:
- [Apollo Server](/apollo-server/) (v?)

## Implementation

Both persisted queries and APQ require you to configure code generation and how your client makes requests. The rest of this article details these configurations.

Persisted queries also requires you to configure your router to enable safelisting. For more information on the other configuration aspects of persisted queries, see the [GraphOS persisted queries documentation](/graphos/operations/persisted-queries).

### 1. Configure code generation

To use persisted queries, your operations need to have a SHA256 hash identifier included in the generated operation objects. To configure code generation you need to set the following two options in your `ApolloCodegenConfiguration` JSON file:

In the `output` section of your configuration set the [`operationManifest`](./../code-generation/codegen-configuration#operation-manifest) with:
- a `version` of either `persistedQueries` or `legacyAPQs`
- a `path` to output the manifest file

```json title="apollo-codegen-config.json"
"output": {
    "operationManifest" : {
        "path" : "./generated/operationIdentifiers.json",
        "version" : "persistedQueries"
    }
}
```

Then in the `options` section of your configuration you will need to set the `operationDocumentFormat` to be either `definition`, `operationId`, or both `definition` and `operationId`. This will determine how to generate the operation documents for your generated operations.

```json title="apollo-codegen-config.json"
"options": {
    "operationDocumentFormat" : [
        "definition",
        "operationId"
    ]
}
```

With the configuration done you can generate the operation manifest. This can be done in 2 ways, using the standard [`generate`](https://www.apollographql.com/docs/ios/code-generation/codegen-cli#generate) command to run code generation will generate the manifest. There is also a CLI command specifically to generate the operation manifest without running full code generation, [`generate-operation-manifest`](https://www.apollographql.com/docs/ios/code-generation/codegen-cli#generate-operation-manifest).

The resulting operation manifest JSON for `persistedQueries` looks like this: 

```json title="operationIdentifiers.json"
{
  "format": "apollo-persisted-query-manifest",
  "version": 1,
  "operations": [
    {
      "id": "e0321f6b438bb42c022f633d38c19549dea9a2d55c908f64c5c6cb8403442fef",
      "body": "query GetItem { thing { __typename } }",
      "name": "GetItem",
      "type": "query"
    }
  ]
}
```

And the resulting operation manifest JSON for `legacyAPQ` would look like this:

```json title="operationIdentifiers.json"
{
  "525cd90917f8945d8d6a68fde991aaf766ff7d7b227ab2cd8dc97b7959c8d0d6" : {
    "name": "GetItem",
    "source": "query GetItem { thing { __typename ...Name } } fragment Name on Item { __typename name }"
  }
}
```

### 2. Enable persisted queries on `ApolloClient`

To query by ID rather than full operation string you need to make some configuration changes. Specifically, you must initialize your `ApolloClient` with a custom `NetworkTransport` that supports persisted queries.

Initialize a `RequestChainNetworkTransport` with `autoPersistQueries` parameter set to `true` and an `interceptorProvider` that includes the `AutomaticPersistedQueryInterceptor` (such as `DefaultInterceptorProvider`).

```swift
let store = ApolloStore(cache: InMemoryNormalizedCache())
let interceptorProvider = DefaultInterceptorProvider(store: store)
let networkTransport = RequestChainNetworkTransport(
    interceptorProvider: interceptorProvider,
    endpointURL: URL(string: "http://localhost:4000/graphql")!
)

let client = ApolloClient(networkTransport: networkTransport, store: store)
```
For more information on configuring your `ApolloClient`, `NetworkTransport`, `InterceptorProvider`, and the request chain, see the [Request Pipeline](./../networking/request-pipeline) documentation.

#### Sending APQs as `GET` requests

By default, the Apollo clients sends operation retries as `POST` requests.  In some cases, you may prefer or need to retry  persisted operation using a `GET` requestâ€”for example, your queries may make requests to a CDN that has better performance with `GET`s.

To use `GET` for persisted query retry requests, set the `useGETForPersistedQueryRetry` on your `RequestChainNetworkTransport` to `true`.

In most cases, keeping the default option (`false`) suffices.

---
title: Persisted Queries
---

Apollo supports two separate but related features called **persisted queries** and **automated persisted queries** (APQs).
With both features, clients can execute a GraphQL operation by sending an operation's ID instead of the entire string. An operation's ID is the SHA256 hash of the full operation string. Querying by ID can significantly reduce latency and bandwidth usage for very large operation strings.

## Differences between persisted queries and APQ

The persisted queries feature requires operations to be preregistered in a **persisted query list** (**PQL**). 
The allows the PQL to act as a safelist of trusted operations made by your first-party apps. As such, persisted queries is a security feature as much as a performance one.

With APQs, if the server can't find the operation ID the client provides, the server returns an error indicating that it needs the full operation string. If the Apollo iOS client receives this error, it automatically retries the operation with the full operation string.

If you _only_ want to improve request latency and bandwidth usage, APQ addresses your use case. If you _also_ want to secure your supergraph with operation safelisting, you should preregister trusted operations in a PQL.

For more details on differences between persisted queries and APQ, see the [GraphOS persisted queries documentation](/graphos/operations/persisted-queries#differences-from-automatic-persisted).

### Requirements

Persisted queries is currently in [preview](/resources/product-launch-stages#preview) and has the following requirements:
- Apollo iOS (v1.0.0+)
- [Apollo Router](/router) (v1.25.0+)
- [GraphOS Enterprise plan](/graphos/enterprise/)

You can use APQ with the following versions of Apollo iOS, Apollo Router, and Apollo Server:
- Apollo iOS (v1.3.1+)
- [Apollo Router](/router) (v0.1.0+)
- [Apollo Server](/apollo-server/) (v1.0.0+)

## Implementation steps

Both persisted queries and APQ require you to configure code generation and how your client makes requests. The rest of this article details these configurations.

Persisted queries also requires you to create and link a PQL and configure your router. For more information on the other configuration aspects of persisted queries, see the [GraphOS persisted queries documentation](/graphos/operations/persisted-queries).

### 1. Configure code generation

The code generation requirements for persisted queries and APQ are the same: your operations need a SHA256 hash identifier included in the generated operation objects. To configure code generation accordingly, make the following changes in your `ApolloCodegenConfiguration` JSON file:

1. In the `output` section of your configuration, set the [`operationManifest`](./../code-generation/codegen-configuration#operation-manifest) with:
- a `path` to output the manifest file
- the `version`: either `persistedQueries` for persisted queries or `legacyAPQs` for APQs

```json title="apollo-codegen-config.json"
"output": {
    "operationManifest" : {
        "path" : "./generated/operationIdentifiers.json",
        "version" : "persistedQueries"
    }
}
```

2. In the `options` section of your configuration, set the `operationDocumentFormat` array to `definition`, `operationId`, or both `definition` and `operationId`. This determines how to generate the operation documents for your generated operations.

```json title="apollo-codegen-config.json"
"options": {
    "operationDocumentFormat" : [
        "definition",
        "operationId"
    ]
}
```

Once you've configured code generation, you generate an operation manifest in one of two ways:
- using the standard [`generate`](./../code-generation/codegen-cli#generate) command 
- using the [`generate-operation-manifest`](./../code-generation/codegen-cli#generate-operation-manifest) command; this generates the operation manifest without running full code generation

The resulting operation manifest for `persistedQueries` looks something like this: 

```json title="operationIdentifiers.json"
{
  "format": "apollo-persisted-query-manifest",
  "version": 1,
  "operations": [
    {
      "id": "e0321f6b438bb42c022f633d38c19549dea9a2d55c908f64c5c6cb8403442fef",
      "body": "query GetItem { thing { __typename } }",
      "name": "GetItem",
      "type": "query"
    }
  ]
}
```

The resulting operation manifest JSON for `legacyAPQ` looks something like this: 

```json title="operationIdentifiers.json"
{
  "525cd90917f8945d8d6a68fde991aaf766ff7d7b227ab2cd8dc97b7959c8d0d6" : {
    "name": "GetItem",
    "source": "query GetItem { thing { __typename ...Name } } fragment Name on Item { __typename name }"
  }
}
```

To automatically update the manifest for each new app release, you can include the [`generate`](./../code-generation/codegen-cli#generate) command in your CI/CD pipeline.

#### Publish manifests to the PQL

<blockquote>

**This step is only required for persisted queries, not APQ.**

Ensure your Rover CLI version is `0.17.2` or later. Previous versions of Rover don't support publishing operations to a PQL.
[Download the latest version.](/rover/getting-started/)

</blockquote>

If you want to preregister your manifest as a safelist of trusted operations , you need to publish it to a PQL using the [Rover CLI](/rover/):

```bash title="Example command"
rover persisted-queries publish my-graph@my-variant \
  --manifest ./persisted-query-manifest.json
```

- Replace `my-graph@my-variant` with the **graph ref** of _any_ variant your PQL is [linked to](#12-link-the-pql-to-variants). Your platform team can provide this for you.
    - Graph refs have the format `graph-id@variant-name`.
- For the `--manifest` option, provide the path to the manifest you want to publish.

**The above command does the following:**

1. It publishes all operations in the provided manifest file to the PQL linked to the specified variant.
    - Publishing a manifest to a PQL is additive. Any _existing_ entries in the PQL remain.
    - If you publish an operation with the same `id` but different details from an existing entry in the PQL, the entire publish command fails with an error.

2. It updates any _other_ variants that the PQL is applied to so that routers associated with those variants can fetch their updated PQL.

As with manifest generation, you can execute this command in your CI/CD pipeline to publish new operations as part of your app release process.

### 2. Enable persisted queries on `ApolloClient`

Once you've configured your code generation to include IDs, you can update your client to query by ID rather than the full operation string. This configuration is the same whether you are using APQ or persisted queries:

- Initialize a custom `NetworkTransport` using `RequestChainNetworkTransport` with `autoPersistQueries` parameter set to `true` and an `interceptorProvider` that includes the `AutomaticPersistedQueryInterceptor` (such as `DefaultInterceptorProvider`).
- Initialize your `ApolloClient` with the custom `NetworkTransport` that supports persisted queries.

```swift
let store = ApolloStore(cache: InMemoryNormalizedCache())
let interceptorProvider = DefaultInterceptorProvider(store: store)
let networkTransport = RequestChainNetworkTransport(
    interceptorProvider: interceptorProvider,
    endpointURL: URL(string: "http://localhost:4000/graphql")!
)

let client = ApolloClient(networkTransport: networkTransport, store: store)
```

For more information on configuring your `ApolloClient`, `NetworkTransport`, `InterceptorProvider`, and the request chain, see the [request pipeline](./../networking/request-pipeline) documentation.

#### Sending APQ retries as `GET` requests

> **Note:** Apollo iOS only retries failed ID-based operations for APQs, not persisted queries.

By default, the Apollo clients sends operation retries as `POST` requests.  In some cases, you may prefer or need to retry an operation using a `GET` request: for example, you may make requests to a CDN that has better performance with `GET`s.

To use `GET` for APQ retry requests, set the `useGETForPersistedQueryRetry` on your `RequestChainNetworkTransport` to `true`.

In most cases, keeping the default option (`false`) suffices.
